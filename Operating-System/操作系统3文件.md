# 文件

+ 定义：文件：一组有意义的数据集合

+ 文件属性：
  + 文件名：同一目录下不允许有重名文件
  + 标识符：用于操作系统区分文件
  + 文件类型：
  + 文件位置：文件存放路径（用户使用）、在外存中的地址（操作系统可见，用户不可见）
  + 创建时间、上次修改时间
  + 文件所有者信息、保护信息
  
+ 文件之间如何组织：树状

  > 目录其实是特殊的有结构文件

+ 从下往上：操作系统为文件提供的功能：

  + 创建目录：`create`系统调用
  + 删除文件：delete
  + 读文件：`read`系统调用
  + 写文件：`write`系统调用
  + 打开文件：open
  + 关闭文件：close

  各种操作是上述几项基本功能的组合

+ 从上往下：内存如何存放在外存：

  外存由一个个存储单元组成，有大小、有位置

  存储单元：块/磁盘块/物理块：大小相等，是2的整数次幂

  文件的逻辑地址分为：逻辑块号、块内地址，操作系统将其转换成外存的物理块号、块内地址

  操作系统是以块为单位为文件分配地址的（计时占不满）

  + 连续还是离散？
  + 管理和回收问题

+ 其他文件：
  + 文件共享
  + 文件保护

## 文件内部组织

+ 文件分类：

  + 无结构文件/流式文件    ：由二进制或字符流组成

  + 有结构文件/记录式文件：由一组相似的记录组成，每条记录有一个数据项作为关键字

    > 数据项：文件系统中最基本的数据单位
    >
    > 记录：一组相关数据项的集合

下面讨论的是有结构文件

1. 顺序文件：文件中的记录逻辑上顺序排列
   + 记录的类型：
     + 定长记录
     + 可变长记录
   + 记录的存储：
     + 顺序存储：逻辑相邻则物理相邻
       + 串结构：记录之间的顺序与关键字无关，按照存入时间
       + 顺序结构：记录之间的顺序按关键字排序
     + 链式存储：不一定

+ 内容查找：
  + 链式存储：不能随机存取
  + 顺序存储：
    + 可变记录：不能随机存储
    + 定长记录：可以随机存储
      + 串结构：不能通过关键字访问
      + 顺序结构：可以通过关键字访问（二分）
+ 文件修改和删除：同数据结构

---

2. 索引文件：解决可变长记录访问慢的问题

   建立一张索引表以加快文件索引速度，每条记录对应一个索引项

   索引表字段：索引号、长度m、指针ptr，且长度固定，所以索引表本身就是定长记录的顺序文件，如果顺序结构可快速检索

---

> 索引文件的索引表本身可能很大

3. 索引顺序文件：同样建立索引表，但是先将记录分组，再对每组建立索引

   索引表字段：键、地址：顺序存储定长记录的串结构的文件：插入更快
   
   + 多级索引表

### 文件目录

+ 文件目录就是FCB的有序集合

+ FCB就是一个文件目录项，包含文件的基本信息：文件名、文件存放的物理地址

  > FCB实现文件名和文件之间的映射，使用户可以按名存取

+ 支持的操作：搜索、创建、删除、显示、修改

+ 目录的发展：

  1. 单极目录结构：整个系统只有一张目录表，不运行文件重名

  2. 两级目录结构：分为Master File Directory主文件目录和User File Directory用户文件目录：允许不同用户之间文件名可重复，同时可实现文件权限，但是每个用户自己不能给自己的文件分配

  3. 多级目录结构：

     + 绝对路径
     + 相对路径

     > 树形目录结构的缺点：不方便实现文件的共享

  4. 无环图目录结构：不同文件名指向同一文件/目录

     为每个共享结点设置一个共享计数器，伤删除只是删除FCB，共享计数器减一，减为0时才删除结点，复制则指增加一个边

+ 索引结点（FCB的改进）：

  > 一个FCB的项很多，但是在文件操作时并不需要这么多信息
  >
  > 另一方面就是这个表很大

  每个文件名对应一个索引结点指针，具体信息在索引结点指针中

  > 索引结点在外存叫磁盘索引结点，在内存叫内存索引结点
  >
  > 内存索引结点需要一些额外的信息：文件是否被修改、有几个进程正在访问

## 文件物理结构（分配方式）

外存硬盘空间是一个个块、文件的逻辑地址也是块

（逻辑块号，块内地址）-》（物理块号，块内地址）

1. 连续分配：要求每个文件在磁盘上占有一组连续的块：具体位置可以之间通过块的大小进行计算来随机访问

   优点：读写快

   缺点：存储空间利用率低，会产生磁盘碎片

2. 链接分配：

   每个文件描述为起始块号和末尾块号

   

   1. 隐式链接：除了最后一个磁盘块都有一个地方存储指针指向下一个块的地址

   2. 显式链接：每个点指向的一下在一个同一的表上存——FAT文件分配表：不需要访问磁盘，可以先计算再过去，算是随机访问

      这个表是常驻内存的，所以快，缺点就是占空间

3. 索引分配

   允许文件离散的分配在各个磁盘块

   > 在磁盘块中而不是内存

   为每个文件建立一张索引表，记录文件的各个逻辑块对应的物理块

   索引表存放的磁盘块叫索引块，文件数据存放的磁盘块叫数据块

   支持随机访问（计算到位置，然后去磁盘看在哪里），还容易扩展

   1. 链接方案：索引表太大，就套娃
      + 多层索引
   2. 混合索引：既有直接索引，又有多级索引





## 存储空间管理

+ 文件卷/逻辑卷：每个盘分成两个区
+ + 目录区：FCB
  + 文件区：文件数据



1. 空闲表法：空间盘块表：第一个空闲盘块号+空间盘块树的表：用于连续分配方法

   + 分配：首次、最佳、最坏适应

   + 回收：

     1. 回收区前后没有相邻空闲区
     2. 前后都是
     3. 前面是
     4. 后面是

     注意表项合并问题

2. 空间链表法：操作系统保存链头、链尾指针

   1. 空间盘块链：每个空间块都是链表的结点

      + 回收：不必考虑前后顺序

   2. 空闲盘区链：一段连续的空间的块是结点

      1. 先找到合适盘区，或者把多个给分配

      + 回收：也要考虑前后

3. 位示图法：直接把整个硬盘看成一个二维地图，做个bool
4. 成组链接法

## 文件操作

1. create创建文件：调用create系统调用

   参数：

   1. 所需的外存空间大小
   2. 文件存放路径
   3. 文件名

   os：

   1. 在外存中找到文件所需的空间

2. delete

   1. 路径
   2. 文件名

   os：

   1. 找到
   2. 回收磁盘块
   3. 删除对应目录项

3. 打开open

   1. 路径
   2. 名
   3. 操作类型

   os：

   1. 找到

      确定权限

   2. 将目录项复制到“打开文件表”

      + 用户打开文件表
      + 系统打开文件表
   
4. 读read

5. 写write



## 文件共享

共享和复制的区别：共享是一个文件

1. 基于索引结点的共享方式（硬链接）：不同用户的目录是文件名和索引结点支付的表，多个用户的索引结点指针指向同一个物理地址。索引结点设置链接技术变量count
2. 基于基于符号链的共享方式（软链接）：不同用户的索引结点指针指向的是一个Link类型的文件，这个文件里存放的是目标文件的地址

## 文件保护

1. 口令保护：使用密码访问，口令存放在文件对应对的PCB或索引结点的

   只有密码才能访问

   + 优点：时间空间开销小
   + 缺点：在系统内部，不够安全

2. 加密保护

   对密码进行加密，有密码才能解密

   + 异或
   
3. 访问控制：在每个文件的PCB或者索引结点添加一个访问控制表Access-Control List， ACL，该表中记录各个用户可以对该文件执行哪些操作

   + 精简：从以用户为单位到以组为单位



## 层次结构

从上到下

0. 用户应用程序

1. 用户接口：用于用户向系统的系统调用

2. 文件目录系统：对文件的管理

3. 存取控制模块：文件保护：确定用户是否有对应权限操作

4. 逻辑文件系统与文件信息缓冲区：用户指明想要访问文件记录号，记录号转换称对应逻辑地址

5. 物理文件系统：把上一层提供的文件逻辑地址转换称实际的物理地址

6. + 辅助分配模块：负责文件存储空间的管理、分配和回收空间

   + 设备管理模块：直接与硬件交互
     + 设备





# 磁盘

+ 磁头、磁盘、磁道、扇区（就是一个磁盘块）（可以进行编号）

  多个盘面，一个盘片可以有两个盘面，分别对应磁头（编号）这里的磁头是统一移动的

  柱面，就是这些多个盘面相对位置想用的磁道组成的

  + 每个磁盘块存储空间一样，但是里面的面积更小，说明信息密度更大

+ 读写：把磁头移动到对应扇区，然后移动到对应磁道，然后转就有了

+ 我们发现可以用一个三元组来定位（柱面号，盘面好、扇区号）

  1. 根据柱面号移动到对应磁道
  2. 激活对应磁盘磁头
  3. 读写

+ 磁头分类：

  + 活动头磁盘：磁臂移动定位磁道
  + 固定头磁盘：每个磁道都有一个磁头

  --

  + 可换盘磁盘
  + 不可

## 磁盘调度算法

+ 一次磁盘读写操作需要的时间

  + 寻找磁道时间：

    + 启动磁头臂时间
    + 移动磁头时间

  + 延迟时间：旋转磁盘使磁头定位到目标扇区所需要的时间

    平均所需的延迟时间Tr = （1 / 2） * （1 / r） = 1 / （2r）

  + 传输时间：从磁盘读出或向磁盘写入数据所经历的时间

    Tt = （1 / r） * （b / N） = b / （rN）

  我们发现后两项和硬件相关，操作系统无法管理，只有第一项可以，所有有不同的磁盘调度算法

1. 先来先服务算法FCFS：根据进程请求访问磁盘的先后顺序进行调度

2. 最短寻找时间优先SSTF：优先处理与当前磁头最近的磁道的磁道请求

   可能产生饥饿

3. 扫描算法SCAN，又叫电梯算法：为了避免贪心的饥饿，只有磁头移动到最外侧时才能往里面移动，繁殖依然，

   + 缺点1：这里的移动是真真的移动到头，不够智能
   + 缺点2：对于各个位置磁道的相应频率不均匀

4. LOOK调度算法：在扫描算法的基础上，如果当前移动方向、再移动也没有请求了，就反向

5. 循环扫错算法C-SCAN：只有往某个特点方向移动时才处理磁道访问请求，返回时快速移动至起始端而不处理请求

6. C-LOOK调度算法

++++延迟时间

到对应磁道后还需要磁盘转来到对应时间

这里磁头读取一个扇区的内容需要时间来处理，但是磁盘一致在旋转，如果是读取一片连续的空间，那就得等磁盘再转一圈，就拉

+ 扇区交替编号：然逻辑上相邻的扇区在物理上不相邻
  + 划过不需要的区域是正是处理实现，然后处理好正好是继续读

》磁盘地址结构设计

为什么三元组是柱面、盘面、扇区，因为这些可以用二进制位表示，而各个扇区是连续的，然后是盘面是不同盘面，因为有多个磁头，并不需要移动磁头，只有最高的的柱面才需要磁头，这样设计一段连续的空间可以尽可能地减少磁头地移动

---

减少延迟时间地方法：错位命名；即相邻盘面的号是错位的，即上一个盘面是一个编号的末尾，而下一个盘面则是末尾，这样上一个盘面最后一个扇区读完，然后等待时间驾驶下一个扇面把那个读完的时间，然后下一个盘面继续读

---

## 磁盘管理

1. 磁盘初始化：
   1. 低级格式化（物理格式化）：讲磁盘的各个磁道划分为扇区。一个扇区分为头尾数据区域，头尾就是扇区的相关信息，还有校验码
   2. 将磁盘分区，每个分区由若干柱面组成
   3. 逻辑格式化，创建文件系统（文件系统根目录、初始化存储空间管理所用的数据结构）

+ 引导块：计算机开机需要一系列的初始化工作，是通过初始化程序-自举程序完成的，这些程序存放在在ROM（出厂即设定之后不能再修改）、

  这里有个问题就是不能更新，放在磁盘的——引导块上-启动分区，位于磁盘上上的固定位置

  用于启动分区的磁盘成为启动磁盘或系统磁盘（C盘）



+ 坏块，无法正常使用的块，属于硬件故障，操作系统无法修复，

  1. 在逻辑格式化的时候在FAT表上表明，对OS不透明，OS管理

  2. 磁盘磁盘控制器维护坏块链表（低级格式化时初始化）

     保留备用扇区替换坏块——扇区备用，这个方式对操作系统时透明
